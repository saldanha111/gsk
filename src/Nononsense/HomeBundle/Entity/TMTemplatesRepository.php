<?php

namespace Nononsense\HomeBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * AreasRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class TMTemplatesRepository extends EntityRepository
{
	public function listActiveForRequest($filters)
    {
        $em = $this->getEntityManager();

        $sintax="";
        $logical=" WHERE ";

        if(!empty($filters)){

            if(isset($filters["name"])){
	            $terms = explode(" ", $filters["name"]);
	            foreach($terms as $key => $term){
	                $sintax.=$logical." (t.name LIKE :name".$key. " OR a.name LIKE :nameArea".$key.")";
	                $parameters["name".$key]="%".$term."%";
	                $parameters["nameArea".$key]="%".$term."%";
	                $logical=" AND ";
	            }
	        }

            if(isset($filters["id"])){
                $sintax.=$logical." t.id=:id";
                $parameters["id"]=$filters["id"];
                $logical=" AND ";
            }

            if(isset($filters["no_request_in_proccess"]) && $filters["no_request_in_proccess"]==1){
                $sintax.=$logical." (t.tmState=6 OR t.tmState=8) AND ((SELECT COUNT(aux.template_id) FROM Nononsense\HomeBundle\Entity\TMTemplates aux WHERE aux.tmState IN (1,2,3,4,5,11))=0)";
                $logical=" AND ";
            }

            if(isset($filters["nest"]) && $filters["nest"]==1){
                $sintax.=$logical." t.tmState=6";
                $logical=" AND ";
                if(isset($filters["parent"])){
                    $sintax.=$logical." t.id!=:parent";
                    $parameters["parent"]=$filters["parent"];
                }
            }
        }


        $query = $em->createQuery("SELECT t FROM Nononsense\HomeBundle\Entity\TMTemplates t LEFT JOIN Nononsense\HomeBundle\Entity\Areas a WITH t.area=a.id ".$sintax." ORDER BY t.name DESC");

        if(isset($filters["limit_from"])){
            $query->setFirstResult($filters["limit_from"]*$filters["limit_many"])->setMaxResults($filters["limit_many"]);
        }
        
        if(!empty($parameters)){
            $query->setParameters($parameters);
        }

        $items=$query->getResult();

        return $items;
    }

    public function list($type,$filters)
    {
        $em = $this->getEntityManager();

        $sintax=" ";
        $logical=" WHERE ";
        $orderby=" ORDER BY t.id DESC, s.id DESC";

        $tables_drop="";
        $fields_drop="";

        if(!empty($filters)){

            if(isset($filters["name"])){
                $terms = explode(" ", $filters["name"]);
                foreach($terms as $key => $term){
                    $sintax.=$logical." t.name LIKE :name".$key;
                    $parameters["name".$key]="%".$term."%";
                    $logical=" AND ";
                }
            }

            if(isset($filters["number"])){
                $sintax.=$logical." t.number=:number";
                $parameters["number"]=$filters["number"];
                $logical=" AND ";
            }

            if(isset($filters["area"])){
                $sintax.=$logical." a.id=:area";
                $parameters["area"]=$filters["area"];
                $logical=" AND ";
            }

            if(isset($filters["state"])){
                $sintax.=$logical." s.id=:state";
                $parameters["state"]=$filters["state"];
                $logical=" AND ";
            }

            if(isset($filters["applicant"])){
                $sintax.=$logical." ua.id=:applicant";
                $parameters["applicant"]=$filters["applicant"];
                $logical=" AND ";
            }

            if(isset($filters["owner"])){
                $sintax.=$logical." uo.id=:owner";
                $parameters["owner"]=$filters["owner"];
                $logical=" AND ";
            }

            if(isset($filters["backup"])){
                $sintax.=$logical." ub.id=:backup";
                $parameters["backup"]=$filters["backup"];
                $logical=" AND ";
            }

            if(isset($filters["draft"])){
                $sintax.=$logical." s.id<5";
                $logical=" AND ";
            }

            if(isset($filters["request_drop"])){
                $sintax.=$logical." sg.action=8 AND sg.tmDropAction IS NULL";
                $logical=" AND ";

                $tables_drop="LEFT JOIN Nononsense\HomeBundle\Entity\TMSignatures sg WITH t.id=sg.template LEFT JOIN Nononsense\UserBundle\Entity\Users ud WITH sg.userEntiy=ud.id";
                $fields_drop=",ud.name applicantDropRequestName,sg.created dropRequestDate";
            }

            if(isset($filters["applicant_drop"])){
                $sintax.=$logical." ud.id=:applicant_drop";
                $parameters["applicant_drop"]=$filters["applicant_drop"];
                $logical=" AND ";
            }

            if(isset($filters["changes_history"])){
                $sintax.=$logical." (t.id=:changes_history1 OR t.firstEdition=:changes_history2)";
                $parameters["changes_history1"]=$filters["changes_history"];
                $parameters["changes_history2"]=$filters["changes_history"];
                $logical=" AND ";
                $orderby="Order by t.id ASC";
            }
        }

        $sintax = " FROM Nononsense\HomeBundle\Entity\TMTemplates t LEFT JOIN Nononsense\HomeBundle\Entity\Areas a WITH t.area=a.id LEFT JOIN Nononsense\HomeBundle\Entity\TMStates s WITH t.tmState=s.id LEFT JOIN Nononsense\UserBundle\Entity\Users ua WITH t.applicant=ua.id LEFT JOIN Nononsense\UserBundle\Entity\Users uo WITH t.owner=uo.id LEFT JOIN Nononsense\UserBundle\Entity\Users ub WITH t.backup=ub.id ".$tables_drop.$sintax;

        switch($type){
            case "list": 
                $query = $em->createQuery("SELECT t.id,t.name,a.name nameArea,t.number,t.numEdition,s.id status,t.inactive,s.name stateName,t.created,t.reference,ua.name applicantName,uo.name ownerName,ub.name backupName,t.effectiveDate,t.reviewDate,t.historyChange,uo.id ownerId,ub.id backupId ".$fields_drop.$sintax." ".$orderby);
                if(isset($filters["limit_from"])){
                    $query->setFirstResult($filters["limit_from"]*$filters["limit_many"])->setMaxResults($filters["limit_many"]);
                }
                
                if(!empty($parameters)){
                    $query->setParameters($parameters);
                }

                $items=$query->getResult();

                break;

            case "count":
                $query = $em->createQuery("SELECT COUNT(DISTINCT t.id) conta ".$sintax);

                if(!empty($parameters)){
                    $query->setParameters($parameters);
                }

                $items=$query->getSingleResult()["conta"];
                break;
        }
        
        return $items;
    }
}