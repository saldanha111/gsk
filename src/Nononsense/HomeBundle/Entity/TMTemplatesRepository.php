<?php

namespace Nononsense\HomeBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * AreasRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class TMTemplatesRepository extends EntityRepository
{
	public function listActiveForRequest($filters)
    {
        $em = $this->getEntityManager();

        $sintax="";
        $logical=" WHERE ";

        if(!empty($filters)){

            if(isset($filters["name"])){
	            $terms = explode(" ", $filters["name"]);
	            foreach($terms as $key => $term){
	                $sintax.=$logical." (t.name LIKE :name".$key. " OR a.name LIKE :nameArea".$key.")";
	                $parameters["name".$key]="%".$term."%";
	                $parameters["nameArea".$key]="%".$term."%";
	                $logical=" AND ";
	            }
	        }

            if(isset($filters["id"])){
                $sintax.=$logical." t.id=:id";
                $parameters["id"]=$filters["id"];
                $logical=" AND ";
            }

            if(isset($filters["no_request_in_proccess"]) && $filters["no_request_in_proccess"]==1){
                $sintax.=$logical." (t.tmState=6 OR t.tmState=8) AND ((SELECT COUNT(aux.template_id) FROM Nononsense\HomeBundle\Entity\TMTemplates aux WHERE aux.tmState IN (1,2,3,4,5,11))=0) AND t.id NOT IN (SELECT aux2.template_id FROM Nononsense\HomeBundle\Entity\TMTemplates aux2 WHERE aux2.template_id=t.id)";
                $logical=" AND ";
            }

            if(isset($filters["nest"]) && $filters["nest"]==1){
                $sintax.=$logical." t.tmState=6";
                $logical=" AND ";
                if(isset($filters["parent"])){
                    $sintax.=$logical." t.id!=:parent";
                    $parameters["parent"]=$filters["parent"];
                }
            }
        }


        $query = $em->createQuery("SELECT t FROM Nononsense\HomeBundle\Entity\TMTemplates t LEFT JOIN Nononsense\HomeBundle\Entity\Areas a WITH t.area=a.id ".$sintax." ORDER BY t.name DESC");

        if(isset($filters["limit_from"])){
            $query->setFirstResult($filters["limit_from"]*$filters["limit_many"])->setMaxResults($filters["limit_many"]);
        }
        
        if(!empty($parameters)){
            $query->setParameters($parameters);
        }

        $items=$query->getResult();

        return $items;
    }

    public function list($type,$filters)
    {
        $em = $this->getEntityManager();

        $sintax=" ";
        $logical=" WHERE ";
        $orderby=" ORDER BY t.id DESC, s.id DESC";

        $tables_extra="";
        $fields_extra="";

        if(!empty($filters)){

            if(isset($filters["name"])){
                $terms = explode(" ", $filters["name"]);
                foreach($terms as $key => $term){
                    $sintax.=$logical." t.name LIKE :name".$key;
                    $parameters["name".$key]="%".$term."%";
                    $logical=" AND ";
                }
            }

            if(isset($filters["number"])){
                $sintax.=$logical." t.number=:number";
                $parameters["number"]=$filters["number"];
                $logical=" AND ";
            }

            if(isset($filters["area"])){
                $sintax.=$logical." a.id=:area";
                $parameters["area"]=$filters["area"];
                $logical=" AND ";
            }

            if(isset($filters["state"])){
                switch($filters["state"]){
                    case 2:
                    case 9:
                        $sintax.=$logical." (s.id=2 OR s.id=9)";
                        break;
                    default:
                        $sintax.=$logical." s.id=:state";
                        $parameters["state"]=$filters["state"];
                }
                
                $logical=" AND ";
            }

            if(isset($filters["applicant"])){
                $sintax.=$logical." ua.id=:applicant";
                $parameters["applicant"]=$filters["applicant"];
                $logical=" AND ";
            }

            if(isset($filters["owner"])){
                $sintax.=$logical." uo.id=:owner";
                $parameters["owner"]=$filters["owner"];
                $logical=" AND ";
            }

            if(isset($filters["backup"])){
                $sintax.=$logical." ub.id=:backup";
                $parameters["backup"]=$filters["backup"];
                $logical=" AND ";
            }

            if(isset($filters["draft"])){
                $sintax.=$logical." s.id<5";
                $logical=" AND ";
            }

            if(isset($filters["request_drop"])){
                $sintax.=$logical." sg.action=8 AND sg.tmDropAction IS NULL";
                $logical=" AND ";

                $tables_extra="LEFT JOIN Nononsense\HomeBundle\Entity\TMSignatures sg WITH t.id=sg.template LEFT JOIN Nononsense\UserBundle\Entity\Users ud WITH sg.userEntiy=ud.id";
                $fields_extra=",ud.name applicantDropRequestName,sg.created dropRequestDate";
            }

            if(isset($filters["applicant_drop"])){
                $sintax.=$logical." ud.id=:applicant_drop";
                $parameters["applicant_drop"]=$filters["applicant_drop"];
                $logical=" AND ";
            }

            if(isset($filters["changes_history"])){
                $sintax.=$logical." (t.id=:changes_history OR t.firstEdition=:changes_history)";
                $parameters["changes_history"]=$filters["changes_history"];
                $logical=" AND ";
                $orderby="Order by t.id ASC";
            }

            if(isset($filters["request_review"])){
                $sintax.=$logical." s.id=6 AND sg.action=12";
                $logical=" AND ";

                $tables_extra="LEFT JOIN Nononsense\HomeBundle\Entity\TMSignatures sg WITH t.requestReview=sg.id LEFT JOIN Nononsense\UserBundle\Entity\Users ud WITH sg.userEntiy=ud.id";
                $fields_extra=",ud.name ReviewRequestName,sg.created ReviewRequestDate";
            }

            if (isset($filters["pending_for_me"])) {
                if(!isset($filters["request_drop"])) {
                    $sintax.=$logical."(".$this->sintax_pending("workflow_where").")";
                }
                else{
                    $sintax.=$logical." (t.id IN (SELECT IDENTITY(w_admin.template) FROM Nononsense\HomeBundle\Entity\TMWorkflow w_admin WHERE w_admin.template=t.id AND w_admin.action=5 AND w_admin.userEntiy=:user))";
                }
            }

            
        }



        $sintax = " FROM Nononsense\HomeBundle\Entity\TMTemplates t LEFT JOIN Nononsense\HomeBundle\Entity\Areas a WITH t.area=a.id LEFT JOIN Nononsense\HomeBundle\Entity\TMStates s WITH t.tmState=s.id LEFT JOIN Nononsense\UserBundle\Entity\Users ua WITH t.applicant=ua.id LEFT JOIN Nononsense\UserBundle\Entity\Users uo WITH t.owner=uo.id LEFT JOIN Nononsense\UserBundle\Entity\Users ub WITH t.backup=ub.id ".$tables_extra.$sintax;

        switch($type){
            case "list": 
                if(isset($filters["user"])){
                    $parameters["user"]=$filters["user"];
                }
                $query = $em->createQuery("SELECT t.id,t.name,a.name nameArea,t.number,t.numEdition,s.id status,t.inactive,s.name stateName,t.created,t.reference,ua.name applicantName,uo.name ownerName,ub.name backupName,t.effectiveDate,t.reviewDate,t.historyChange,uo.id ownerId,ub.id backupId,t.dateReview,t.needNewEdition,t.notFillableItSelf, CASE WHEN ".$this->sintax_pending('workflow_select')." THEN 1 ELSE 0 END require_action ".$fields_extra.$sintax." ".$orderby);
                if(isset($filters["limit_from"])){
                    $query->setFirstResult($filters["limit_from"]*$filters["limit_many"])->setMaxResults($filters["limit_many"]);
                }
                
                if(!empty($parameters)){
                    $query->setParameters($parameters);
                }

                $items=$query->getResult();

                break;

            case "count":
                if(isset($filters["pending_for_me"]) && isset($filters["user"])){
                    $parameters["user"]=$filters["user"];
                }
                $query = $em->createQuery("SELECT COUNT(DISTINCT t.id) conta ".$sintax);

                if(!empty($parameters)){
                    $query->setParameters($parameters);
                }

                $items=$query->getSingleResult()["conta"];
                break;
        }
        
        return $items;
    }

    private function sintax_pending($table_alias){
        $admins="CASE WHEN t.tmState=5 OR t.tmState=11 THEN 5 ELSE 0 END";
        $aprobs="CASE WHEN t.tmState=4 THEN 4 ELSE ".$admins." END";
        $testers="CASE WHEN t.tmState=3 THEN 3 ELSE ".$aprobs." END";
        $elaborators="CASE WHEN t.tmState=2 OR t.tmState=9 THEN 2 ELSE ".$testers." END";
        $sintax_pending=" (t.tmState=1 AND (t.backup=:user OR t.owner=:user)) OR (t.id IN (SELECT IDENTITY(".$table_alias.".template) FROM Nononsense\HomeBundle\Entity\TMWorkflow ".$table_alias." WHERE ".$table_alias.".template=t.id AND ".$table_alias.".action=".$elaborators." AND ".$table_alias.".userEntiy=:user))";

        return $sintax_pending;
    }
}