<?php

namespace Nononsense\HomeBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Query\ResultSetMapping;

/**
 * AreasRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class TMTemplatesRepository extends EntityRepository
{
	public function listActiveForRequest($filters)
    {
        $em = $this->getEntityManager();

        $sintax="";
        $logical=" WHERE ";

        if(!empty($filters)){

            if(isset($filters["name"])){
	            $terms = explode(" ", $filters["name"]);
	            foreach($terms as $key => $term){
	                $sintax.=$logical." (t.name LIKE :name".$key. " OR a.name LIKE :nameArea".$key.")";
	                $parameters["name".$key]="%".$term."%";
	                $parameters["nameArea".$key]="%".$term."%";
	                $logical=" AND ";
	            }
	        }

            if(isset($filters["id"])){
                $sintax.=$logical." t.id=:id";
                $parameters["id"]=$filters["id"];
                $logical=" AND ";
            }

            if(isset($filters["no_request_in_proccess"]) && $filters["no_request_in_proccess"]==1){
                $sintax.=$logical." (t.tmState=6 OR t.tmState=8 OR t.tmState=14) AND t.id NOT IN (SELECT aux2.template_id FROM Nononsense\HomeBundle\Entity\TMTemplates aux2 WHERE aux2.template_id=t.id)";
                $logical=" AND ";
            }

            if(isset($filters["nest"]) && $filters["nest"]==1){
                $sintax.=$logical." t.tmState=6";
                $logical=" AND ";
                if(isset($filters["parent"])){
                    $sintax.=$logical." t.id!=:parent";
                    $parameters["parent"]=$filters["parent"];
                }
            }
        }


        $query = $em->createQuery("SELECT t FROM Nononsense\HomeBundle\Entity\TMTemplates t LEFT JOIN Nononsense\HomeBundle\Entity\Areas a WITH t.area=a.id ".$sintax." ORDER BY t.name DESC");

        if(isset($filters["limit_from"])){
            $query->setFirstResult($filters["limit_from"]*$filters["limit_many"])->setMaxResults($filters["limit_many"]);
        }
        
        if(!empty($parameters)){
            $query->setParameters($parameters);
        }

        $items=$query->getResult();

        return $items;
    }

    public function list($type,$filters)
    {



















        $em = $this->getEntityManager();

        switch($type){
            case "list":
                $list = $this->createQueryBuilder('t')
                    ->select('t.logbook','t.uniqid','t.id','t.name','a.name nameArea','t.number','t.numEdition','s.id status','t.inactive','s.name stateName','t.created','t.reference','ua.name applicantName','uo.name ownerName','ub.name backupName','t.effectiveDate','t.reviewDate','t.historyChange','uo.id ownerId','ub.id backupId','t.dateReview','t.needNewEdition','t.notFillableItSelf','q.id qr');

                if(isset($filters["order"])){
                    switch($filters["order"]){
                        case 2: 
                            $list->addSelect("(SELECT COUNT(cvr.id) FROM Nononsense\HomeBundle\Entity\CVRecords cvr WITH t.id=cvr.template LEFT JOIN Nononsense\HomeBundle\Entity\CVSignatures cvs WITH cvr.id=cvs.record AND cvs.user=:user) used");
                            break;
                    }
                }

                if(isset($filters["user"])){
                    $list->setParameter('user', $filters["user"]);
                    $list->addSelect("CASE WHEN ".$this->sintax_pending('workflow_select')." THEN 1 ELSE 0 END require_action");
                }

                break;
            case "count":
                $list = $this->createQueryBuilder('t')
                    ->select('COUNT(DISTINCT t.id) as conta');
                break;
        }


        $list->leftJoin("t.area", "a")
            ->leftJoin("t.tmState", "s")
            ->leftJoin("t.QRType", "q")
            ->leftJoin("t.applicant", "ua")
            ->leftJoin("t.owner", "uo")
            ->leftJoin("t.backup", "ub");

        
         

        if($type=="list"){
            $list->orderBy('t.id', 'DESC');    
            $list->addOrderBy('s.id', 'DESC');
        }



        if(!empty($filters)){

            if(isset($filters["name"])){
                $terms = explode(" ", $filters["name"]);
                foreach($terms as $key => $term){
                    $list->andWhere('t.name LIKE :name'.$key);
                    $list->setParameter('name'.$key, '%' . $term. '%');
                }
            }

            if(isset($filters["number"])){
                $list->andWhere('t.number=:number');
                $list->setParameter('number', $filters["number"]);
            }

            if(isset($filters["applicant"])){
                $list->andWhere('ua.id=:applicant');
                $list->setParameter('applicant', $filters["applicant"]);
            }

            if(isset($filters["owner"])){
                $list->andWhere('uo.id=:owner');
                $list->setParameter('owner', $filters["owner"]);
            }

            if(isset($filters["backup"])){
                $list->andWhere('ub.id=:backup');
                $list->setParameter('backup', $filters["backup"]);
            }

            if(isset($filters["draft"])){
                $list->andWhere('s.id<5');
            }

            if(isset($filters["applicant_drop"])){
                $list->andWhere('ud.id=:applicant_drop');
                $list->setParameter('applicant_drop', $filters["applicant_drop"]);
            }

            if(isset($filters["changes_history"])){
                $list->andWhere('(t.id=:changes_history OR t.firstEdition=:changes_history)');
                $list->setParameter('changes_history', $filters["changes_history"]);
                $list->orderBy('t.id', 'ASC');
            }

            if(isset($filters["id"])){
                $list->andWhere('t.id=:id');
                $list->setParameter('id', $filters["id"]);
            }


            if(isset($filters["init_cumplimentation"])){
                $list->andWhere('s.id=6 AND (t.inactive!=1 OR t.inactive IS NULL) AND (t.notFillableItSelf!=1 OR t.notFillableItSelf IS NULL)');
            }

            if(isset($filters["nest_init_cumplimentation"])){
                $list->andWhere('s.id=6 AND (t.inactive!=1 OR t.inactive IS NULL)');
            }

            if(isset($filters["request_drop"])){
                $list->andWhere('sg.action=8 AND sg.tmDropAction IS NULL');
                $list->addSelect("ud.name applicantDropRequestName");
                $list->addSelect("sg.created dropRequestDate");

                /*$list->leftJoin("t.area", "a")

                $tables_extra="LEFT JOIN Nononsense\HomeBundle\Entity\TMSignatures sg WITH t.id=sg.template LEFT JOIN Nononsense\UserBundle\Entity\Users ud WITH sg.userEntiy=ud.id";*/
            }

            if(isset($filters["request_review"])){
                $list->andWhere('s.id=6 AND sg.action=12');
                $list->addSelect("ud.name ReviewRequestName");
                $list->addSelect("sg.created ReviewRequestDate");

                /*$tables_extra="LEFT JOIN Nononsense\HomeBundle\Entity\TMSignatures sg WITH t.requestReview=sg.id LEFT JOIN Nononsense\UserBundle\Entity\Users ud WITH sg.userEntiy=ud.id";*/
            }


            if(isset($filters["state"])){
                switch($filters["state"]){
                    case 2:
                    case 9:
                        $list->andWhere('(s.id=2 OR s.id=9)');
                        break;
                    default:
                        $list->andWhere('s.id=:state');
                        $list->setParameter('state', $filters["state"]);
                }
                
                $logical=" AND ";
            }


            if(isset($filters["area"])){
                $list->andWhere('a.id=:area');
                $list->setParameter('area', $filters["area"]);
            }

            if (isset($filters["pending_for_me"])) {
                if(!isset($filters["request_drop"])) {
                    $list->andWhere("(".$this->sintax_pending("workflow_where").")");
                }
                else{
                    $list->andWhere("t.id IN (SELECT IDENTITY(w_admin.template) FROM Nononsense\HomeBundle\Entity\TMWorkflow w_admin WHERE w_admin.template=t.id AND w_admin.action=5 AND w_admin.userEntiy=:user)");
                }
            }
        }


        if(isset($filters["limit_from"])){
            $list->setFirstResult($filters["limit_from"]*$filters["limit_many"])->setMaxResults($filters["limit_many"]);
        }

        $query = $list->getQuery();

        switch($type){
            case "list":
                return $query->getResult();
                break;
            case "count":
                return $query->getSingleResult()["conta"];
                break;
        }
    }

    private function sintax_pending($table_alias){
        $admins="CASE WHEN t.tmState=5 OR t.tmState=11 THEN 5 ELSE 0 END";
        $aprobs="CASE WHEN t.tmState=4 THEN 4 ELSE ".$admins." END";
        $testers="CASE WHEN t.tmState=3 THEN 3 ELSE ".$aprobs." END";
        $elaborators="CASE WHEN t.tmState=2 OR t.tmState=9 THEN 2 ELSE ".$testers." END";
        $sintax_pending=" (t.tmState=1 AND (t.backup=:user OR t.owner=:user)) OR (t.id IN (SELECT IDENTITY(".$table_alias.".template) FROM Nononsense\HomeBundle\Entity\TMWorkflow ".$table_alias." WHERE ".$table_alias.".template=t.id AND ".$table_alias.".action=".$elaborators." AND ".$table_alias.".userEntiy=:user))";

        return $sintax_pending;
    }

    public function activity($type,$filters)
    {
        $em = $this->getEntityManager();

        switch($type){
            case "list":

                if(isset($filters["group"])){
                    switch($filters["group"]){
                        case 1: 
                            $list = $this->createQueryBuilder('t')
                                ->select('t.id','t.name','s.name state','t.numEdition');
                            break;
                    }
                }
                else{
                    $list = $this->createQueryBuilder('t')
                        ->select('t.id','t.name','s.name state','t.numEdition');
                }
                


                break;
            case "count":
                $list = $this->createQueryBuilder('t')
                    ->select('COUNT(t.id) as conta');
                break;
        }

        $list->leftJoin("t.area", "a3")
            ->leftJoin("t.tmState", "s");

        if(!empty($filters)){

            if(isset($filters["plantilla_id"])){
                $list->andWhere('t.id=:plantilla_id');
                $list->setParameter('plantilla_id', $filters["plantilla_id"]);
            }

            if(isset($filters["name"])){
                $terms = explode(" ", $filters["name"]);
                foreach($terms as $key => $term){
                    $list->andWhere('t.name LIKE :name'.$key);
                    $list->setParameter('name'.$key, '%' . $term. '%');
                }
            }

            if(isset($filters["area"])){
                $list->andWhere('a3.id=:area');
                $list->setParameter('area', $filters["area"]);
            }
        }

        if(isset($filters["group"])){
            switch($filters["group"]){
                case 1: 
                    $list->andWhere('s.id=7 or s.id=8'); // Cargamos las obsoletas y las dadas de baja
                    if($type=="list"){
                        $list->orderBy('t.id', 'DESC');
                    }
                    break;
            }
        }


        if(isset($filters["limit_from"])){
            $list->setFirstResult($filters["limit_from"]*$filters["limit_many"])->setMaxResults($filters["limit_many"]);
        }

        $query = $list->getQuery();


        switch($type){
            case "list":
                return $query->getResult();
                break;
            case "count":
                /*if(isset($filters["group"]) && $filters["group"]=="3"){
                    return count($query->getResult());
                }
                else{*/
                    return $query->getSingleResult()["conta"];
                //}
                break;
        }
    }

    public function activityAux($type,$filters)
    {
        $em = $this->getEntityManager();
        $rsm = new ResultSetMapping();

        $sintax=" ";
        $logical=" WHERE ";
        $orderby=" ";
        $groupby=" ";
        $limit="";

        $tables_extra="";
        $fields_extra="";

        if(!empty($filters)){

            if(isset($filters["name"])){
                $terms = explode(" ", $filters["name"]);
                foreach($terms as $key => $term){
                    $sintax.=$logical." t.name LIKE :name".$key;
                    $parameters["name".$key]="%".$term."%";
                    $logical=" AND ";
                }
            }

            if(isset($filters["plantilla_id"])){
                $sintax.=$logical." t.id=:plantilla_id";
                $parameters["plantilla_id"]=$filters["plantilla_id"];
                $logical=" AND ";
            }

            if(isset($filters["area"])){
                $sintax.=$logical." a3.id=:area";
                $parameters["area"]=$filters["area"];
                $logical=" AND ";
            }

            if(isset($filters["group"])){
                switch($filters["group"]){
                    case 2: 
                        $groupby=" GROUP BY r.template_id,t.name";
                        $orderby=" ORDER BY conta DESC";
                        $sintax = " FROM cv_records r LEFT JOIN tm_templates t ON r.template_id=t.id LEFT JOIN areas a3 ON t.area_id=a3.id ".$tables_extra.$sintax;
                        break;
                    case 3: 
                        $sintax.=$logical." t.first_edition IS NOT NULL";
                        $groupby=" GROUP BY t.first_edition,t.name";
                        $orderby=" ORDER BY conta DESC";
                        $sintax = " FROM tm_templates t LEFT JOIN areas a3 ON t.area_id=a3.id ".$tables_extra.$sintax;
                        break;
                    case 4: 
                        $sintax.=$logical." t.first_edition IS NOT NULL AND diff_edition_days<90";
                        $groupby=" GROUP BY t.first_edition,t.name";
                        $orderby=" ORDER BY conta DESC";
                        $sintax = " FROM tm_templates t LEFT JOIN areas a3 ON t.area_id=a3.id ".$tables_extra.$sintax;
                        break;
                }
            }
        }


        

        switch($type){
            case "list": 
                
                if(isset($filters["limit_from"])){
                    $limit=" OFFSET :from ROWS FETCH NEXT :many ROWS ONLY";
                    $parameters["from"]=$filters["limit_from"]*$filters["limit_many"];
                    $parameters["many"]=$filters["limit_many"];
                }


                switch($filters["group"]){
                    case 2: 
                        $query = $em->createNativeQuery("SELECT t.name,COUNT(r.template_id) as conta".$fields_extra.$sintax." ".$groupby." ".$orderby." ".$limit,$rsm);
                        break;
                    case 3: 
                    case 4: 
                        $query = $em->createNativeQuery("SELECT t.name,COUNT(t.id) as conta".$fields_extra.$sintax." ".$groupby." ".$orderby." ".$limit,$rsm);
                        break;
                }

                
                $rsm->addScalarResult('name', 'name');
                $rsm->addScalarResult('conta', 'conta');                
                if(!empty($parameters)){
                    $query->setParameters($parameters);
                }

                $items=$query->getResult();


                break;

            case "count":

                switch($filters["group"]){
                    case 2: 
                        $query = $em->createNativeQuery("SELECT COUNT(DISTINCT r.template_id) conta ".$sintax,$rsm);
                        break;
                    case 3: 
                    case 4:
                        $query = $em->createNativeQuery("SELECT COUNT(DISTINCT t.first_edition) conta ".$sintax,$rsm);
                        break;
                }
                
                $rsm->addScalarResult('conta', 'conta');
                if(!empty($parameters)){
                    $query->setParameters($parameters);
                }

                $items=$query->getSingleResult()["conta"];
                break;
        }
        
        return $items;
    }
}