<?php

namespace Nononsense\HomeBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Query\ResultSetMapping;

/**
 * CVRecordsRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CVRecordsRepository extends EntityRepository
{
	public function search($type,$filters)
    {
        $em = $this->getEntityManager();
        $require_blocked = null;
        $require_gxp = null;
        if(!empty($filters)){
            if (isset($filters["user"])) {
                $user = $filters["user"];

                $groups=array();
                foreach($user->getGroups() as $uniq_group){
                    $groups[]=$uniq_group->getGroup();
                }
            }
            $key=0;
            if (isset($filters["usersc"]) || isset($filters["usersv"])) {
                $types_cumpl=array(1 => "c",2 => "v");
                foreach($types_cumpl as $key_type_cumpl => $type_cumpl){
                    if(isset($filters["users".$type_cumpl])){
                        foreach($filters["users".$type_cumpl] as $uniq_user){
                            $array_users[$key]["user"] = $uniq_user;
                            $groups=array();
                            $array_users[$key]["groups"]=array();
                            foreach($array_users[$key]["user"]->getGroups() as $uniq_group){
                                $array_users[$key]["groups"][]=$uniq_group->getGroup();
                            }
                            $array_users[$key]["types"]=$key_type_cumpl;
                            $key++;
                        }

                    }

                }

                $require_action="CASE  WHEN ";
                $operator="";
                foreach($array_users as $key => $array_item){
                    $array_types[$key]=$key_type_cumpl;
                    $require_action.=$operator."(sig.user=:eluser1".$key." OR (sig.user IS NULL AND last.user is NULL) 
                            OR
                            (
                                t.correlative=TRUE AND sig.user IS NULL AND ty.id=:type".$key." AND (w.user=:eluser1".$key." OR (w.group IN (:groups".$key.") AND :eluser3".$key." NOT IN (SELECT IDENTITY(vvv1_".$key.".user) FROM Nononsense\HomeBundle\Entity\CVWorkflow vvv1_".$key." WHERE vvv1_".$key.".record=i.id AND vvv1_".$key.".user IS NOT NULL)  AND :eluser3".$key." NOT IN (SELECT IDENTITY(vvv2_".$key.".user) FROM Nononsense\HomeBundle\Entity\CVSignatures vvv2_".$key." LEFT JOIN  Nononsense\HomeBundle\Entity\CVActions vvv3_".$key." WITH vvv2_".$key.".action=vvv3_".$key.".id WHERE vvv2_".$key.".record=i.id AND (vvv3_".$key.".type!=a.type OR vvv2_".$key.".finish=TRUE)) ))
                            )
                            OR
                            (
                                t.correlative=FALSE AND sig.user IS NULL AND ty.id=:type".$key." AND (
                                     :eluser2".$key." IN (SELECT IDENTITY(vvv5_".$key.".user) FROM Nononsense\HomeBundle\Entity\CVWorkflow vvv5_".$key." LEFT JOIN  Nononsense\HomeBundle\Entity\TMCumplimentations vvv11_".$key." WITH vvv5_".$key.".type=vvv11_".$key.".id WHERE vvv5_".$key.".record=i.id AND vvv5_".$key.".signed=FALSE AND vvv11_".$key.".tmType=s.type) AND :eluser3".$key." NOT IN (SELECT IDENTITY(vvv6_".$key.".user) FROM Nononsense\HomeBundle\Entity\CVSignatures vvv6_".$key." LEFT JOIN  Nononsense\HomeBundle\Entity\CVActions vvv7_".$key." WITH vvv6_".$key.".action=vvv7_".$key.".id WHERE vvv6_".$key.".record=i.id AND (vvv7_".$key.".type!=a.type OR vvv6_".$key.".finish=TRUE))
                                )
                            )
                            OR
                            (
                                t.correlative=FALSE AND sig.user IS NULL AND ty.id=:type".$key." AND (SELECT COUNT(vvv8_".$key.".id) FROM Nononsense\HomeBundle\Entity\CVWorkflow vvv8_".$key."  LEFT JOIN  Nononsense\HomeBundle\Entity\TMCumplimentations vvv12_".$key." WITH vvv8_".$key.".type=vvv12_".$key.".id WHERE vvv8_".$key.".record=i.id AND vvv12_".$key.".tmType=s.type AND vvv8_".$key.".signed=FALSE AND vvv8_".$key.".group IN (:groups".$key."))>0  AND :eluser3".$key." NOT IN (SELECT IDENTITY(vvv9_".$key.".user) FROM Nononsense\HomeBundle\Entity\CVSignatures vvv9_".$key." LEFT JOIN  Nononsense\HomeBundle\Entity\CVActions vvv10_".$key." WITH vvv9_".$key.".action=vvv10_".$key.".id WHERE vvv9_".$key.".record=i.id AND (vvv10_".$key.".type!=a.type OR vvv9_".$key.".finish=TRUE))
                            )
                        )";
                        $operator=" OR ";
                }
                $require_action.=" THEN 1 ELSE 0 END";
            }

            if (isset($filters["users"])) {
                unset($array_users);
                foreach($filters["users"] as $key => $uniq_user){
                    $array_users[$key]["user"] = $uniq_user;
                    $groups=array();
                    $array_users[$key]["groups"]=array();
                    foreach($array_users[$key]["user"]->getGroups() as $uniq_group){
                        $array_users[$key]["groups"][]=$uniq_group->getGroup();
                    }
                }

                $require_gxp="CASE  WHEN ";
                $operator="";
                foreach($array_users as $key => $array_item){
                    $require_gxp.=$operator."(i.id IN (SELECT IDENTITY(ccc_gxp_".$key.".record) FROM Nononsense\HomeBundle\Entity\CVSecondWorkflow ccc_gxp_".$key." WHERE ccc_gxp_".$key.".signed=FALSE AND ccc_gxp_".$key.".type=1 AND (ccc_gxp_".$key.".user=:eluser1".$key." OR ccc_gxp_".$key.".group IN (:groups".$key.")))
                    )";
                    $operator=" OR ";
                }
                $require_gxp.=" THEN 1 ELSE 0 END";

                $require_blocked="CASE  WHEN ";
                $operator="";
                foreach($array_users as $key => $array_item){
                    $require_blocked.=$operator."(i.id IN (SELECT IDENTITY(bbb_sby_".$key.".record) FROM Nononsense\HomeBundle\Entity\CVSecondWorkflow bbb_sby_".$key." WHERE bbb_sby_".$key.".signed=FALSE AND bbb_sby_".$key.".type=2 AND (bbb_sby_".$key.".user=:eluser1".$key." OR bbb_sby_".$key.".group IN (:groups".$key.")))
                
                    )";
                    $operator=" OR ";
                }
                $require_blocked.=" THEN 1 ELSE 0 END";

            }
        }

        /*$require_action="CASE  WHEN 
            (sig.user=:eluser1 OR (sig.user IS NULL AND last.user is NULL) 
                OR
                (
                    t.correlative=TRUE AND sig.user IS NULL AND  (w.user=:eluser1 OR (w.group IN (:groups) AND :eluser2 NOT IN (SELECT IDENTITY(vvv1.user) FROM Nononsense\HomeBundle\Entity\CVWorkflow vvv1 WHERE vvv1.record=i.id)  AND :eluser2 NOT IN (SELECT IDENTITY(vvv2.user) FROM Nononsense\HomeBundle\Entity\CVSignatures vvv2 LEFT JOIN  Nononsense\HomeBundle\Entity\CVActions vvv3 WITH vvv2.action=vvv3.id WHERE vvv2.record=i.id AND (vvv3.type!=a.type OR vvv2.finish=TRUE)) ))
                )
                OR
                (
                    t.correlative=FALSE AND sig.user IS NULL AND (
                         :eluser2 IN (SELECT IDENTITY(vvv5.user) FROM Nononsense\HomeBundle\Entity\CVWorkflow vvv5 LEFT JOIN  Nononsense\HomeBundle\Entity\TMCumplimentations vvv11 WITH vvv5.type=vvv11.id WHERE vvv5.record=i.id AND vvv5.signed=FALSE AND vvv11.tmType=s.type) AND :eluser2 NOT IN (SELECT IDENTITY(vvv6.user) FROM Nononsense\HomeBundle\Entity\CVSignatures vvv6 LEFT JOIN  Nononsense\HomeBundle\Entity\CVActions vvv7 WITH vvv6.action=vvv7.id WHERE vvv6.record=i.id AND (vvv7.type!=a.type OR vvv6.finish=TRUE))
                    )
                )
                OR
                (
                    t.correlative=FALSE AND sig.user IS NULL AND (SELECT COUNT(vvv8.id) FROM Nononsense\HomeBundle\Entity\CVWorkflow vvv8  LEFT JOIN  Nononsense\HomeBundle\Entity\TMCumplimentations vvv12 WITH vvv8.type=vvv12.id WHERE vvv8.record=i.id AND vvv12.tmType=s.type AND vvv8.signed=FALSE AND vvv8.group IN (:groups))>0  AND :eluser2 NOT IN (SELECT IDENTITY(vvv9.user) FROM Nononsense\HomeBundle\Entity\CVSignatures vvv9 LEFT JOIN  Nononsense\HomeBundle\Entity\CVActions vvv10 WITH vvv9.action=vvv10.id WHERE vvv9.record=i.id AND (vvv10.type!=a.type OR vvv9.finish=TRUE))
                )
            ) THEN 1 ELSE 0 END";

        $require_gxp="CASE  WHEN 
            (i.id IN (SELECT IDENTITY(ccc_gxp.record) FROM Nononsense\HomeBundle\Entity\CVSecondWorkflow ccc_gxp WHERE ccc_gxp.signed=FALSE AND ccc_gxp.type=1 AND (ccc_gxp.user=:eluser1 OR ccc_gxp.group IN (:groups)))
                
            ) THEN 1 ELSE 0 END";

        $require_blocked="CASE  WHEN 
            (i.id IN (SELECT IDENTITY(bbb_sby.record) FROM Nononsense\HomeBundle\Entity\CVSecondWorkflow bbb_sby WHERE bbb_sby.signed=FALSE AND bbb_sby.type=2 AND (bbb_sby.user=:eluser1 OR bbb_sby.group IN (:groups)))
                
            ) THEN 1 ELSE 0 END";*/

        switch($type){
            case "list":
                $list = $this->createQueryBuilder('i')
                    ->select('i.id', 't.number', 't.numEdition', 't.name','u.name creator','i.created','i.modified','t.logbook','s.name state','s.nameReconc stateReconc','i.inEdition','t.logbook','a.nameAlternative pendingAction','sigu.id idNextSigner','ty.name type','s.final finalState','s.color colorState','s.icon iconState','s.canBeOpened canBeOpenedState','s.nameAlternative alternativeState','s.nameAlternativeReconc  alternativeStateReconc','ty.id type_id','sig.version','a.id action','s.id state_id','IDENTITY(i.reconciliation) reconId','IDENTITY(i.firstReconciliation) reconFirstId','ar.name area','IDENTITY(i.firstNested) firstNestedId','IDENTITY(last.action) lastAction','IDENTITY(sig.action) lastActionUnsigned','IDENTITY(i.userGxP) usergxp','i.ecoNextOnStandBy');

                if((!isset($filters["gxp"]) && !isset($filters["blocked"]))){
                    if(isset($require_action)){
                        $list->addSelect($require_action." AS requireAction");
                    }
                }

                if(!empty($filters) && isset($filters["have_json"])){
                    $list->addSelect('i.json');
                }

                if(isset($filters["gxp"]) && $filters["gxp"] && $require_gxp){
                    $list->addSelect($require_gxp." AS allow_gxp");
                }

                if(isset($filters["blocked"]) && $filters["blocked"] && $require_blocked){
                    $list->addSelect($require_blocked." AS allow_blocked");
                }

                break;
            case "count":
                $list = $this->createQueryBuilder('i')
                    ->select('COUNT(i.id) as conta');
                break;
        }

        if($type=="list" || isset($filters["pending_for_me"]) || isset($filters["pending_blocked"]) || isset($filters["pending_gxp"])){
            if(isset($array_users)){
                foreach($array_users as $key => $item_array){
                    $list->setParameter('eluser1'.$key, $item_array["user"]);
                    $list->setParameter('groups'.$key, $item_array["groups"]);
                    if(array_key_exists("types",$item_array)){
                        $list->setParameter('type'.$key, $item_array["types"]);
                    }

                    if(!isset($filters["gxp"]) && !isset($filters["blocked"])){
                        $list->setParameter('eluser2'.$key, $item_array["user"]->getId());
                        $list->setParameter('eluser3'.$key, $array_users[0]["user"]->getId());    
                    }
                }
            }
        }
        

        $list->leftJoin("i.template", "t")
            ->leftJoin("i.user", "u")
            ->leftJoin("i.state", "s")
            ->leftJoin("t.area", "ar")
            ->leftJoin("i.cvWorkflows", "w", "WITH", "(w.id = (SELECT MIN(aux.id) FROM Nononsense\HomeBundle\Entity\CVWorkflow aux WHERE aux.record=i.id AND aux.signed=FALSE))")
            ->leftJoin("i.cvSignatures", "sig", "WITH", "(sig IS NULL OR sig.id = (SELECT MAX(aux2.id) FROM Nononsense\HomeBundle\Entity\CVSignatures aux2 WHERE aux2.record=i.id AND aux2.signed=FALSE))")
            ->leftJoin("i.cvSignatures", "last", "WITH", "(last.id = (SELECT MAX(aux3.id) FROM Nononsense\HomeBundle\Entity\CVSignatures aux3 WHERE aux3.record=i.id AND aux3.signed=TRUE))")
            ->leftJoin("sig.action", "a")
            ->leftJoin("s.type", "ty")
            ->leftJoin("sig.user", "sigu");
            

        if($type=="list"){
            $list->orderBy('i.id', 'DESC');
        }

        $list->andWhere('i.retentionRemovedAt IS NULL');

        if(!empty($filters)){

            if(isset($filters["id"])){
                $list->andWhere('i.id=:id');
                $list->setParameter('id', $filters["id"]);
            }

            if(isset($filters["have_json"])){
                $list->andWhere('i.json IS NOT NULL');
            }

            if(isset($filters["not_this"])){
                $list->andWhere('i.id!=:not_this');
                $list->setParameter('not_this', $filters["not_this"]);
            }


            if(isset($filters["plantilla_id"])){
                $list->andWhere('t.id=:plantilla_id');
                $list->setParameter('plantilla_id', $filters["plantilla_id"]);
            }

            if(isset($filters["blocked"]) && $filters["blocked"]){
                $list->andWhere('i.blocked=1');

                if(isset($filters["pending_blocked"]) && $filters["pending_blocked"]){
                    $require_blocked=str_replace("bbb", "bbb2", $require_blocked);
                    $list->andWhere($require_blocked.'=1');
                }
            }

            if(isset($filters["gxp"]) && $filters["gxp"]){
                $list->andWhere('i.userGxP IS NOT NULL');

                if(isset($filters["pending_gxp"]) && $filters["pending_gxp"]){
                    $require_gxp=str_replace("ccc", "ccc2", $require_gxp);
                    $list->andWhere($require_gxp.'=1');
                }
            }

            if(isset($filters["name"])){
                $terms = explode(" ", $filters["name"]);
                foreach($terms as $key => $term){
                    $list->andWhere('t.name LIKE :name'.$key);
                    $list->setParameter('name'.$key, '%' . $term. '%');
                }
            }

            if(isset($filters["creator"])){
                $terms = explode(" ", $filters["creator"]);
                foreach($terms as $key => $term){
                    $list->andWhere('u.name LIKE :creator'.$key);
                    $list->setParameter('creator'.$key, '%' . $term. '%');
                }
            }


            if(isset($filters["content"])){
                $terms = explode(" ", $filters["content"]);
                foreach($terms as $key => $term){
                    $list->andWhere('last.json LIKE :content'.$key);
                    $list->setParameter('content'.$key, '%' . $term. '%');
                }
            }

            if(isset($filters["fll"]) && $filters["fll"]=="1"){
                $fll=1;
            }
            else{
                $fll=0;
            }

            if(isset($filters["status"])){
                switch($filters["status"]){
                    case -1:
                        $list->andWhere('i.reconciliation IS NOT NULL');
                        break;
                    case -2:
                        $list->andWhere('s.id=1 AND (SELECT COUNT(ret.id) FROM Nononsense\HomeBundle\Entity\cvSignatures ret WHERE IDENTITY(ret.action)=6 AND IDENTITY(ret.record)=i.id)>0');
                        break;
                    case -3:
                        $list->andWhere('s.final IS NULL');
                        break;
                    case -4:
                        $list->andWhere('i.inEdition=1');
                        break;
                    case -5:
                        $list->andWhere('s.final=TRUE');
                        break;
                    case 9:
                        $list->andWhere('i.blocked=1');
                        break;
                    default:
                        $list->andWhere('i.state=:state');
                        $list->setParameter('state', $filters["status"]);
                        break;
                }

            }

            if (isset($filters["pending_for_me"])) {
                $require_action=str_replace("vvv", "zzz", $require_action);
                $list->andWhere($require_action.'=1');
            }

            if(isset($filters["area"])){
                $list->andWhere('ar.id=:area');
                $list->setParameter('area', $filters["area"]);
            }


            if(isset($filters["from"])){
                $list->andWhere('i.created>=:from');
                $list->setParameter('from', $filters["from"]);
            }

            if(isset($filters["until"])){
                $list->andWhere('i.created<=:until');
                $list->setParameter('until', $filters["until"]." 23:59:00");
            }

            if(isset($filters["var"]) && isset($filters["value"])){
              
                $list->andWhere("(last.json LIKE :var_1 AND SUBSTRING(
                    last.json,
                    CHARINDEX(:var_2, last.json,0) + LENGTH(:var_2),
                    CHARINDEX('}',last.json,(CHARINDEX(:var_2, last.json,0) + LENGTH(:var_2)))
                        -(CHARINDEX(:var_2, last.json,0) + LENGTH(:var_2))
                    ) LIKE :valueJson) OR 
                    (last.jsonInfo LIKE :var_1 AND SUBSTRING(
                    last.jsonInfo,
                    CHARINDEX(:var_2, last.jsonInfo,0) + LENGTH(:var_2),
                    CHARINDEX('}',last.jsonInfo,(CHARINDEX(:var_2, last.jsonInfo,0) + LENGTH(:var_2)))
                        -(CHARINDEX(:var_2, last.jsonInfo,0) + LENGTH(:var_2))
                    ) LIKE :valueJson) 
                    OR last.json LIKE :var_simple 
                    OR last.jsonInfo LIKE :var_simple");

                
                $list->setParameter('var_1', '%'.$filters["var"].'%');
                $list->setParameter('var_2', '"'.$filters["var"].'":{');
                $list->setParameter('var_simple', '%"'.$filters["var"].'":"'.$filters["value"].'"%');
                $list->setParameter('valueJson', '%:"'.$filters["value"].'"%');
            }

            if(isset($filters["code_unique"])){
                /*if (array_key_exists('gsk_template_id', $filters["code_unique"])) {
                    $list->andWhere("t.id=:gsk_template_id OR t.id IN (SELECT cu_aux.firstEdition FROM Nononsense\HomeBundle\Entity\TMTemplates cu_aux WHERE cu_aux.id=:gsk_template_id) OR t.firstEdition IN (SELECT cu_aux2.firstEdition FROM Nononsense\HomeBundle\Entity\TMTemplates cu_aux2 WHERE cu_aux2.id=:gsk_template_id)");
                    $list->setParameter('gsk_template_id', $filters["code_unique"]["gsk_template_id"]);
                    unset($filters["code_unique"]["gsk_template_id"]);
                }*/
                $strlen=strlen(json_encode($filters["code_unique"]));
                $list->andWhere("LENGTH(i.codeUnique)=:strlen");
                $list->andWhere("ISJSON(i.codeUnique) > 0");
                $list->setParameter('strlen', $strlen);
                $cu=0;
                foreach($filters["code_unique"] as $key_unique => $value_unique){
                    $list->andWhere("JSON_VALUE(i.codeUnique, :var".$cu.") LIKE :value".$cu);
                    $list->setParameter('var'.$cu, '$.'.$key_unique);
                    $list->setParameter('value'.$cu, $value_unique);
                    $cu++;
                }
            }

            if(isset($filters["have_signature"])){
                $list->andWhere('last.signed=TRUE');
            }

            if(isset($filters["recon_history"])){
                //$list->andWhere('i.id=:recon_history OR i.id IN (SELECT recon_aux2.id FROM Nononsense\HomeBundle\Entity\CVRecords recon_aux2 WHERE (IDENTITY(recon_aux2.firstReconciliation) = (SELECT IDENTITY(recon_aux1.firstReconciliation) FROM Nononsense\HomeBundle\Entity\CVRecords recon_aux1 WHERE recon_aux1.reconciliation=:recon_history) OR recon_aux2.id = (SELECT IDENTITY(recon_aux3.firstReconciliation) FROM Nononsense\HomeBundle\Entity\CVRecords recon_aux3 WHERE recon_aux3.reconciliation=:recon_history)))');
                $list->andWhere('i.id=:recon_history OR i.firstReconciliation=:recon_history');
                $list->setParameter('recon_history', $filters["recon_history"]);
            }

            if(isset($filters["nested_history"])){
                $list->andWhere('i.id=:nested_history OR IDENTITY(i.firstNested)=:nested_history');
                $list->setParameter('nested_history', $filters["nested_history"]);
            }
        }


        if(isset($filters["limit_from"])){
            $list->setFirstResult($filters["limit_from"]*$filters["limit_many"])->setMaxResults($filters["limit_many"]);
        }

        $query = $list->getQuery();

        switch($type){
            case "list":
                return $query->getResult();
                break;
            case "count":
                return $query->getSingleResult()["conta"];
                break;
        }
    }

    public function list($type,$filters)
    {
        $em = $this->getEntityManager();
        $rsm = new ResultSetMapping();
        

        $sintax=" ";
        $logical=" WHERE ";
        $orderby=" ORDER BY cv.id DESC, s.id DESC";

        $tables_extra="";
        $fields_extra="";

        if(empty($filters) || !isset($filters["retention_action"]) || $filters["retention_action"]!="4"){
            $sintax.=$logical." cv.retention_removed_at IS NULL";
            $logical=" AND ";
        }
        else{
            $sintax.=$logical." cv.retention_removed_at IS NOT NULL";
            $logical=" AND ";
        }

        if(!empty($filters)){
            if(isset($filters["name"])){
                $terms = explode(" ", $filters["name"]);
                foreach($terms as $key => $term){
                    $sintax.=$logical." t.name LIKE :name".$key;
                    $parameters["name".$key]="%".$term."%";
                    $logical=" AND ";
                }
            }

            if(isset($filters["number"])){
                $sintax.=$logical." t.number=:number";
                $parameters["number"]=$filters["number"];
                $logical=" AND ";
            }

            if(isset($filters["template"])){
                $sintax.=$logical." t.id=:template";
                $parameters["template"]=$filters["template"];
                $logical=" AND ";
            }

            if(isset($filters["area"])){
                $sintax.=$logical." a.id=:area";
                $parameters["area"]=$filters["area"];
                $logical=" AND ";
            }

            if(isset($filters["state"])){
                $sintax.=$logical." s.id IN (:state)";
                $parameters["state"]=explode(",", $filters["state"]);
                $logical=" AND ";
            }

            if(isset($filters["id"])){
                $sintax.=$logical." cv.id=:id";
                $parameters["id"]=$filters["id"];
                $logical=" AND ";
            }

            if(isset($filters["retentions"])){
                $sintax.=$logical." cv.id IN (:retentions)";
                $parameters["retentions"]=$filters["retentions"];
                $logical=" AND ";
            }
            
            if(isset($filters["retention_type"])){
                $sintax.=$logical." s.id IN (3,6,7)";
                $logical=" AND ";

                $tables_extra.=" LEFT JOIN tm_retentions tmr ON tmr.tmtemplates_id=t.id AND tmr.retentioncategories_id = (SELECT TOP 1 rc2.id FROM retention_categories rc2 LEFT JOIN rc_states rcs2 ON rc2.document_state=rcs2.id AND rcs2.type=2 WHERE s.id IN (SELECT value FROM STRING_SPLIT(rcs2.relational_id,',')) AND rc2.id IN (SELECT tmr2.retentioncategories_id FROM tm_retentions tmr2 WHERE tmr2.tmtemplates_id=t.id) ORDER BY rc2.retention_days DESC) LEFT JOIN retention_categories rc ON tmr.retentioncategories_id=rc.id LEFT JOIN users cu ON rc.destroy_user=cu.id LEFT JOIN groups cg ON rc.destroy_group=cg.id LEFT JOIN rc_states rcs ON rc.document_state=rcs.id LEFT JOIN cv_signatures accret ON accret.record_id=cv.id AND accret.id = (SELECT MAX(accret2.id) FROM cv_signatures accret2 LEFT JOIN cv_actions cva ON accret2.action_id=cva.id WHERE cva.next_state=s.id AND accret2.record_id=cv.id)";
                $fields_extra.=",rc.name mostRestrictiveCategory, accret.modified retentionDate, DATEADD(day,rc.retention_days,accret.modified) DestructionDate,cu.id confirmUser,cg.id confirmGroup,cu.name confirmUserName,cg.name confirmGroupName";
                $rsm->addScalarResult('mostRestrictiveCategory', 'mostRestrictiveCategory');
                $rsm->addScalarResult('DestructionDate', 'DestructionDate');
                $rsm->addScalarResult('retentionDate', 'retentionDate');
                $rsm->addScalarResult('confirmUser', 'confirmUser');
                $rsm->addScalarResult('confirmGroup', 'confirmGroup');
                $rsm->addScalarResult('confirmUserName', 'confirmUserName');
                $rsm->addScalarResult('confirmGroupName', 'confirmGroupName');
                $orderby=" ORDER BY DestructionDate DESC";

                if(isset($filters["category"])){
                    $terms = explode(" ", $filters["category"]);
                    foreach($terms as $key => $term){
                        $sintax.=$logical." rc.name LIKE :category".$key;
                        $parameters["category".$key]="%".$term."%";
                        $logical=" AND ";
                    }
                }

                if(isset($filters["destruction_from"])){
                    $sintax.=$logical." DATEADD(day,rc.retention_days,accret.modified)>=:destruction_from";
                    $parameters["destruction_from"]=$filters["destruction_from"];
                    $logical=" AND ";
                }

                if(isset($filters["destruction_until"])){
                    $sintax.=$logical." DATEADD(day,rc.retention_days,accret.modified)<=:destruction_until";
                    $parameters["destruction_until"]=$filters["destruction_until"];
                    $logical=" AND ";
                }

                if(isset($filters["retention_from"])){
                    $sintax.=$logical." CASE accret.modified>=:retention_from";
                    $parameters["retention_from"]=$filters["retention_from"];
                    $logical=" AND ";
                }

                if(isset($filters["retention_until"])){
                    $sintax.=$logical." CASE accret.modified<=:retention_until";
                    $parameters["retention_until"]=$filters["retention_until"];
                    $logical=" AND ";
                }

                if(isset($filters["agent"])){
                    $sintax.=$logical." cu.id=:agent";
                    $parameters["agent"]=$filters["agent"];
                    $logical=" AND ";
                }

                if(isset($filters["group_agent"])){
                    $sintax.=$logical." cg.id=:group_agent";
                    $parameters["group_agent"]=$filters["group_agent"];
                    $logical=" AND ";
                }

                if(isset($filters["retention_action"])){
                    switch($filters["retention_action"]){
                        case "2":   $sintax.=$logical." DATEADD(day,rc.retention_days,accret.modified)<=DATEADD(month,6,GETDATE()) AND (rc.destroy_user=:confirm_user_retention OR rc.destroy_group IN (:confirm_groups_retention))";
                                    $logical=" AND ";
                                    $parameters["confirm_user_retention"]=$filters["user_retention"];
                                    $parameters["confirm_groups_retention"]=$filters["groups_retention"];
                            break;
                        case "3":   $sintax.=$logical." DATEADD(day,rc.retention_days,accret.modified)<=GETDATE() AND (rc.destroy_user=:confirm_user_retention OR rc.destroy_group IN (:confirm_groups_retention))";
                                    $logical=" AND ";
                                    $parameters["confirm_user_retention"]=$filters["user_retention"];
                                    $parameters["confirm_groups_retention"]=$filters["groups_retention"];
                            break;
                    }
                    
                }

                if(isset($filters["notify_retention"])){
                    $sintax.=$logical." DATEADD(day,rc.retention_days,accret.modified)<=GETDATE()";
                        $logical=" AND ";
                }
            }

        }



        $sintax = " FROM cv_records cv LEFT JOIN tm_templates t ON cv.template_id=t.id LEFT JOIN areas a ON t.area_id=a.id LEFT JOIN cv_states s ON cv.state_id=s.id LEFT JOIN users uo ON t.owner_id=uo.id LEFT JOIN users ub ON t.backup_id=ub.id ".$tables_extra.$sintax;

        switch($type){
            case "list": 
                if(isset($filters["limit_from"])){
                    $limit=" OFFSET :from ROWS FETCH NEXT :many ROWS ONLY";
                    $parameters["from"]=$filters["limit_from"]*$filters["limit_many"];
                    $parameters["many"]=$filters["limit_many"];
                }
                else{
                    $limit=" OFFSET 0 ROWS FETCH NEXT 999999999 ROWS ONLY";
                }
                
                $query = $em->createNativeQuery("SELECT cv.id,t.name,a.name nameArea,t.number,t.num_edition numEdition,s.name stateName,t.id templateId,uo.name ownerName,ub.name backupName,t.effectiveDate".$fields_extra.$sintax." ".$orderby.$limit,$rsm);



                $rsm->addScalarResult('id', 'id');
                $rsm->addScalarResult('name', 'name');
                $rsm->addScalarResult('templateId', 'templateId');
                $rsm->addScalarResult('nameArea', 'nameArea');
                $rsm->addScalarResult('number', 'number');
                $rsm->addScalarResult('numEdition', 'numEdition');
                $rsm->addScalarResult('reviewDateRetention', 'reviewDateRetention');
                $rsm->addScalarResult('stateName', 'stateName');
                $rsm->addScalarResult('ownerName', 'ownerName');
                $rsm->addScalarResult('backupName', 'backupName');
                $rsm->addScalarResult('effectiveDate', 'effectiveDate');

                if(!empty($parameters)){
                    $query->setParameters($parameters);
                }


                $items=$query->getResult();
                break;

            case "count":
                $query = $em->createNativeQuery("SELECT COUNT(DISTINCT cv.id) conta ".$sintax,$rsm);

                $rsm->addScalarResult('conta', 'conta');
                if(!empty($parameters)){
                    $query->setParameters($parameters);
                }

                $items=$query->getSingleResult()["conta"];
                break;

        }
        
        return $items;
    }
}
