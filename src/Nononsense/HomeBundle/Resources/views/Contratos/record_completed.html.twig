{% extends '::base.html.twig' %}
{% block page_title %}Docoaro - GSK | {{'Homepage'|trans}} {% endblock %}
{% block head %}
{{ parent() }}
<style>


</style>
{% endblock %}
{% block main_title %} Se ha rellenado el registro del documento {{documentName}}{% endblock %}
{% block content %}
<div class="wrapper wrapper-content">
    {% for flashMessage in app.session.flashbag.get('error') %}
    <div class="alert alert-danger alert-dismissable" style="margin: 10px 16px 0 16px">
        <button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button>
        {{ flashMessage }}
    </div>
    {% endfor %}
    <div class="row">


        {% if validated == 1 %}
            <h1>El documento está completado</h1>
            <form method="POST" id="guardarenviarForm" action="{{path('nononsense_record_save_send', {'id': id})}}" enctype="multipart/form-data">

            {% if anexo == 1 %}
                <h2>Adjuntar anexo</h2>
                <input type='file' name="anexo" id="anexo" /><br>
            {% else %}
                <input type="hidden" value="1" id="no_anexo">
            {% endif %}  

            {% if can_sign == 1 %}
                <div id="signature-pad" class="input-group">
                    <h2>Introduzca su contraseña para firmar el documento</h2>
                    <input type="password" name="password" id="box_password" class="form-control" required="required"><br>
                </div><br>
            {% endif %} 

            {% if can_sign == 1 or anexo == 1 %}
                <input type="hidden" id="firma" name="firma"/>
                <a class="btn btn-default" href="{{path('nononsense_records')}}" name="volver">Volver</a>
                <a class="btn btn-success" name="guardarenviar" id="guardarenviar">Enviar</a>

            {% endif %} 
        {% elseif validated == 2 %}
            <h1>Documento firmado!</h1>
            El documento ha sido firmado
        {% else %}
            <h1>Documento guardado!</h1>
            El documento está a la espera de ser completado
        {% endif %}
    </form>
    </div>
    <hr>
    <input type="hidden" id="dev" value={{devolucion}}>
</div>
</div>
{% endblock %}
{% block scripts %}
{{ parent() }}
<script>


    $(document).ready(function () {

        toastr.options = {
            "closeButton": true,
            "debug": false,
            "progressBar": true,
            "positionClass": "toast-top-center",
            "onclick": null,
            "showDuration": "400",
            "hideDuration": "1000",
            "timeOut": "7000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        }

        ActivateMenu('docxpresso_home');
        $('#side-menu').metisMenu();


        $('a[name="cancelarRegistro"]').on('click', function () {
            $("#editModal").show();
        });

        $('#editBtnNo').click(function () {
            $("#editModal").hide();

        });

        $('#guardarenviar').on('click', function () {
            if($('#anexo').val() || $('#no_anexo').val()){
                if($("#box_password").length){
                    $(this).hide(function() {
                        valid_password=password_valid($("#box_password").val());
                        console.log(valid_password);
                        if (!valid_password) {
                            $(this).show();
                            toastr.error("La contraseña es incorecta", 'aviso');
                        } else {
                            $("#guardarenviarForm").submit();
                        }
                    });

                }
                else{
                    $("#guardarenviarForm").submit();
                }
            }
            else{
                toastr.error("Debe adjuntar un Anexo", 'aviso');
            }
        });

        $('#guardarRegistro').on('click', function () {
            var comentarioCompulsory = "{{devolucion}}"
            if (comentarioCompulsory == 1) {
                var comment = $('#comment').val()
                if(comment == ""){
                    // error
                    toastr.error("Debe escribir una justificación del cambio realizado, no puede dejar el cuadro en blanco", 'aviso');
                    return false;
                }
            }
            if($("#box_password").length){
                if (!password_valid($("#box_password").val())) {
                    toastr.error("La contraseña es incorecta", 'aviso');

                } else {
                    $("#guardarRegistroForm").submit();
                }
            }
            else{
                $("#guardarRegistroForm").submit();
            }

        });

        function password_valid(password){
            var result;
            $.ajax({
                url: "{{ path('nononsense_mclean_get_sign_valid') }}",
                type: 'POST',
                dataType: 'json',
                async: false,
                data: {password: password},
                success: function(response) {
                    console.log(response);
                    if(response.valid){
                        result=true;
                    }else{
                        result=false;
                    }
                },
                error: function() {
                    result=false;
                }
            });

            return result;
        }

        $('#guardarenviarForm input').on('keypress', function(e) {
            return e.which !== 13;
        });
    });

</script>
{% endblock %}
