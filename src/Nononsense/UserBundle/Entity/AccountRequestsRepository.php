<?php

namespace Nononsense\UserBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Tools\Pagination\Paginator;

/**
 * AccountRequestsRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class AccountRequestsRepository extends EntityRepository
{
	 public function listBy($filter, $limit = 20){
        $list  = $this->createQueryBuilder('u')
                // ->addSelect('(SELECT COUNT(arg1.requestId) FROM NononsenseUserBundle:AccountRequestsGroups AS arg1 WHERE arg1.requestId = u.id AND arg1.status IS NOT NULL) as revised')
                // ->join('u.request','x')
                // ->addSelect('x')
                ->addOrderBy('u.status','ASC')
                ->addOrderBy('u.created','ASC');

        if (isset($filter['status']) && is_numeric($filter['status'])) {
            $list->andWhere('x.status = :status');
            $list->setParameter('status', $filter["status"]);
        }

        if (isset($filter['mudid']) && $filter['mudid']) {
            $list->andWhere('u.mudid LIKE :mudid');
            $list->setParameter('mudid', '%'.$filter["mudid"].'%');
        }

        if (isset($filter['username']) && $filter['username']) {
            $list->andWhere('u.username LIKE :username');
            $list->setParameter('username', '%'.$filter["username"].'%');
        }

        if(isset($filter["from"]) && $filter['from']){
            $list->andWhere('u.created >= :from');
            $list->setParameter('from', $filter["from"]);
        }

        if(isset($filter["until"]) && $filter['until']){
            $list->andWhere('u.created <= :until');
            $list->setParameter('until', $filter["until"]." 23:59:00");
        }

        $list->setFirstResult($limit*($filter["page"]-1))->setMaxResults($limit);

        $accountRequests['rows']  = $list->getQuery()->getResult();
        $accountRequests['count'] = count(new Paginator($list));

        return $accountRequests;
    }

}
